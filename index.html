<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workout Logger</title>
  <style>
    body { font-family: sans-serif; background:#f4f7f6; margin:0; padding:20px; }
    .container { max-width: 900px; margin:auto; background:#fff; padding:20px 30px; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
    h1,h2,h3 { text-align:center; color:#2c3e50; }
    input, textarea { width:100%; margin-bottom:10px; padding:10px; border:1px solid #ccc; border-radius:4px; }
    button { padding:10px 15px; border:none; border-radius:4px; cursor:pointer; }
    #signup-btn,#login-btn { background:#3498db; color:white; margin-right:5px; }
    #logout-btn { background:#e74c3c; color:white; float:right; }
    #share-btn { background:#27ae60; color:white; margin-top:15px; }
    .page { display:none; }
    .page.active { display:block; }
    .tab-buttons { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-bottom:20px; }
    .tab-button { background:#ecf0f1; border:1px solid #bdc3c7; padding:8px 12px; cursor:pointer; border-radius:5px 5px 0 0; }
    .tab-button.active { background:#fff; font-weight:bold; border-color:#3498db; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .exercise-table { width:100%; border-collapse:collapse; margin-top:10px; }
    .exercise-table th,.exercise-table td { border:1px solid #ddd; padding:8px; font-size:14px; }
    .exercise-table th { background:#f2f2f2; }
    .error-message { color:red; text-align:center; margin-top:10px; }
  </style>
</head>
<body>
  <div class="container">

    <!-- Auth Section -->
    <div id="auth-section">
      <h2>Login / Signup</h2>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button id="signup-btn">Sign Up</button>
      <button id="login-btn">Log In</button>
      <p id="auth-error" style="color:red;"></p>
    </div>

    <!-- App Section -->
    <div id="app-section" style="display:none;">
      <button id="logout-btn">Log Out</button>

      <div id="input-page" class="page active">
        <h1>Workout Logger</h1>
        <textarea id="log-input" placeholder="Paste your workout log here..."></textarea>
        <button id="log-btn">Log Workout</button>
        <button id="view-history-btn">View History</button>
        <button id="share-btn">Share Public Link</button>
        <div id="share-link" style="margin-top:10px; color:#27ae60;"></div>
        <div id="error-message" class="error-message"></div>
      </div>

      <div id="output-page" class="page">
        <div class="nav-buttons">
          <button id="back-to-input-btn">Back to Input</button>
        </div>
        <div id="tab-buttons-container" class="tab-buttons"></div>
        <div id="tab-contents-container"></div>
        <p id="no-history-message" style="text-align:center; color:#777; margin-top:20px;">
          No workout history found. Log your first workout!
        </p>
      </div>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { 
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { 
      collection, addDoc, getDocs, doc, setDoc 
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // UI refs
    const authSection = document.getElementById('auth-section');
    const appSection = document.getElementById('app-section');
    const authError = document.getElementById('auth-error');
    const logInput = document.getElementById('log-input');
    const errorMessageDiv = document.getElementById('error-message');
    const tabsContainer = document.getElementById('tab-buttons-container');
    const contentsContainer = document.getElementById('tab-contents-container');
    const noHistoryMessage = document.getElementById('no-history-message');

    // Auth handlers
    document.getElementById('signup-btn').onclick = async () => {
      const email = email.value, password = password.value;
      try { await createUserWithEmailAndPassword(auth, email, password); }
      catch (err) { authError.textContent = err.message; }
    };
    document.getElementById('login-btn').onclick = async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try { await signInWithEmailAndPassword(auth, email, password); }
      catch (err) { authError.textContent = err.message; }
    };
    document.getElementById('logout-btn').onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
      if (user) { authSection.style.display = 'none'; appSection.style.display = 'block'; }
      else { authSection.style.display = 'block'; appSection.style.display = 'none'; }
    });

    // Page switching
    document.getElementById('view-history-btn').onclick = () => showPage('output-page');
    document.getElementById('back-to-input-btn').onclick = () => showPage('input-page');

    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      if (pageId === 'output-page') renderHistory();
    }

    // Workout logging
    document.getElementById('log-btn').onclick = async () => {
      const logText = logInput.value.trim();
      errorMessageDiv.textContent = '';
      if (!logText) { errorMessageDiv.textContent = "Please paste a workout log."; return; }
      try {
        const workout = parseLogText(logText);
        await addDoc(collection(db, "users", auth.currentUser.uid, "workouts"), workout);
        logInput.value = '';
        showPage('output-page');
      } catch (e) {
        errorMessageDiv.textContent = "Error parsing log: " + e.message;
      }
    };

    function parseLogText(text) {
      const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
      const workout = { type:"", date:"", exercises:[] };
      let currentExercise=null, state="FIND_TYPE";
      for (const line of lines) {
        if (state==="FIND_TYPE") {
          const m=line.match(/^(Full body \d|Cardio|Upper Body|Lower Body)$/i);
          if (m){ workout.type=m[1]; state="FIND_DATE"; continue; }
        }
        if (state==="FIND_DATE") {
          const m=line.match(/^(.*?)\s+at\s+.*$/i);
          if (m){ workout.date=m[1]; state="PARSE_EXERCISES"; continue; }
        }
        if (state==="PARSE_EXERCISES") {
          const ex=line.match(/^([A-Za-z\s]+?)(?:\s*\((.*?)\))?$/);
          if (ex){ if(currentExercise) workout.exercises.push(currentExercise);
            currentExercise={name:ex[1].trim(), details:ex[2]||"", sets:[]}; continue; }
          const set=line.match(/^Set \d+:\s*(.*)$/);
          if (set && currentExercise){
            const d=set[1]; const s={isWarmup:d.includes("[Warm-up]")};
            const wr=d.match(/(\d+)\s*(?:lbs|kg)?\s*x\s*(\d+)/i);
            if(wr){ s.load=parseFloat(wr[1]); s.reps=parseInt(wr[2]); } else { s.duration=d; }
            currentExercise.sets.push(s);
          }
        }
      }
      if (currentExercise) workout.exercises.push(currentExercise);
      if (!workout.date || workout.exercises.length===0) throw new Error("Could not parse log");
      return workout;
    }

    async function renderHistory() {
      tabsContainer.innerHTML=""; contentsContainer.innerHTML="";
      const snap=await getDocs(collection(db,"users",auth.currentUser.uid,"workouts"));
      if (snap.empty){ noHistoryMessage.style.display="block"; return; }
      noHistoryMessage.style.display="none";
      const workoutsByType={};
      snap.forEach(doc=>{ const w=doc.data(); (workoutsByType[w.type]??=[]).push(w); });
      let first=true;
      Object.entries(workoutsByType).forEach(([type,workouts])=>{
        const btn=document.createElement('button');
        btn.textContent=type; btn.classList.add('tab-button'); tabsContainer.appendChild(btn);
        const div=document.createElement('div'); div.classList.add('tab-content'); contentsContainer.appendChild(div);
        let html=""; const exercises={};
        workouts.forEach(w=>w.exercises.forEach(ex=>{
          (exercises[ex.name]??=[]).push({date:w.date, sets:ex.sets});
        }));
        for(const [name,hist] of Object.entries(exercises)){
          html+=`<h3>${name}</h3><table class="exercise-table"><thead><tr><th>#</th><th>Date</th>`;
          for(let i=1;i<=5;i++){ html+=`<th colspan="2">Set ${i}</th>`; }
          html+=`<th>Volume</th></tr><tr><th></th><th></th>`;
          for(let i=1;i<=5;i++){ html+=`<th>Load</th><th>Reps</th>`; }
          html+=`<th>(lbs)</th></tr></thead><tbody>`;
          hist.forEach((h,i)=>{
            let vol=0; html+=`<tr><td>${i+1}</td><td>${h.date}</td>`;
            for(let j=0;j<5;j++){ const s=h.sets[j];
              if(s){ if(s.duration){ html+=`<td colspan="2">${s.duration}</td>`; }
                else{ if(!s.isWarmup) vol+=s.load*s.reps;
                  const wu=s.isWarmup?" (Warm-up)":""; html+=`<td>${s.load??"-"}</td><td>${s.reps??"-"}${wu}</td>`; }}
              else html+=`<td>-</td><td>-</td>`;
            }
            html+=`<td>${vol||"-"}</td></tr>`;
          });
          html+="</tbody></table>";
        }
        div.innerHTML=html;
        btn.onclick=()=>{ document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
          btn.classList.add('active'); div.classList.add('active'); };
        if(first){ btn.classList.add('active'); div.classList.add('active'); first=false; }
      });
    }

    // Public link sharing
    document.getElementById('share-btn').onclick = async () => {
      const uid=auth.currentUser.uid;
      await setDoc(doc(db,"publicLinks",uid),{ created:new Date() });
      const link=`${window.location.origin}${window.location.pathname}?uid=${uid}`;
      document.getElementById('share-link').innerText="Shareable link: "+link;
    };

    // Handle public view
    const urlParams=new URLSearchParams(window.location.search);
    if(urlParams.has("uid")){
      const uid=urlParams.get("uid");
      authSection.style.display="none"; appSection.style.display="block";
      document.getElementById("logout-btn").style.display="none";
      document.getElementById("input-page").style.display="none";
      showPage("output-page");
      renderHistoryPublic(uid);
    }

    async function renderHistoryPublic(uid){
      tabsContainer.innerHTML=""; contentsContainer.innerHTML="";
      const snap=await getDocs(collection(db,"users",uid,"workouts"));
      if (snap.empty){ noHistoryMessage.style.display="block"; return; }
      noHistoryMessage.style.display="none";
      const workoutsByType={};
      snap.forEach(doc=>{ const w=doc.data(); (workoutsByType[w.type]??=[]).push(w); });
      let first=true;
      Object.entries(workoutsByType).forEach(([type,workouts])=>{
        const btn=document.createElement('button'); btn.textContent=type; btn.classList.add('tab-button'); tabsContainer.appendChild(btn);
        const div=document.createElement('div'); div.classList.add('tab-content'); contentsContainer.appendChild(div);
        let html=""; const exercises={};
        workouts.forEach(w=>w.exercises.forEach(ex=>{
          (exercises[ex.name]??=[]).push({date:w.date,sets:ex.sets});
        }));
        for(const [name,hist] of Object.entries(exercises)){
          html+=`<h3>${name}</h3><table class="exercise-table"><thead><tr><th>#</th><th>Date</th>`;
          for(let i=1;i<=5;i++){ html+=`<th colspan="2">Set ${i}</th>`; }
          html+=`<th>Volume</th></tr><tr><th></th><th></th>`;
          for(let i=1;i<=5;i++){ html+=`<th>Load</th><th>Reps</th>`; }
          html+=`<th>(lbs)</th></tr></thead><tbody>`;
          hist.forEach((h,i)=>{
            let vol=0; html+=`<tr><td>${i+1}</td><td>${h.date}</td>`;
            for(let j=0;j<5;j++){ const s=h.sets[j];
              if(s){ if(s.duration){ html+=`<td colspan="2">${s.duration}</td>`; }
                else{ if(!s.isWarmup) vol+=s.load*s.reps;
                  const wu=s.isWarmup?" (Warm-up)":""; html+=`<td>${s.load??"-"}</td><td>${s.reps??"-"}${wu}</td>`; }}
              else html+=`<td>-</td><td>-</td>`;
            }
            html+=`<td>${vol||"-"}</td></tr>`;
          });
          html+="</tbody></table>";
        }
        div.innerHTML=html;
        btn.onclick=()=>{ document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
          btn.classList.add('active'); div.classList.add('active'); };
        if(first){ btn.classList.add('active'); div.classList.add('active'); first=false; }
      });
    }
  </script>
</body>
</html>
